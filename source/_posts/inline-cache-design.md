---
title: inline_cache_design
categories:
  - vm
tags:
  - vm
date: 2025-03-21 23:33:24
---

## 背景

动态语言的符号绑定是动态的，会随着程序的执行而发生变化，因此，在程序执行过程中需要先获取符号的地址，才能执行符号对应的代码。这相比静态语言程序执行多了符号查找的开销，因为静态语言的符号都在编译时静态绑定了，所以它可以在程序执行过程中直接执行符号对应的代码。这也是许多动态语言性能不如静态语言的原因之一。（如下例子）

为什么动态语言的符号绑定是动态的呢？有个原因是因为动态语言的对象类型是动态的，导致在运行之前无法根据类型确定对象的布局，从而无法确定符号的地址。但是为了提高动态语言的性能，有需要尽可能地降低这些符号绑定的开销。因此，人们根据局部性原理提出了一些投机和缓存的算法，其中一个称为in-line cache。这个优化是在动态语言的执行环境里实现的，一般称这个执行环境为虚拟机或执行引擎。

本文下面基于QuickJS这个Javascript的虚拟机，描述如何在虚拟机里实现in-line cache优化算法。首先介绍in-line cache的基本概念，然后介绍in-line cache实现的概要设计和详细设计，最后给出测试数据和结论。

<!-- more -->

## 基本概念

inline-cache优化是虚拟机中非常古老的技术，它最早是在Smalltalk编程语言的虚拟机上实现的。inline-cache的原理是利用局部性原理降低符号绑定的开销，对于同一个符号的访问，它会将前一次解析到的符号地址缓存到cache中，并且cache是直接放在当前访问指令上（这也是这个算法被称为in-line的原因，每个cache都直接放在当前指令行上）。下次在访问该符号的时候只要简单校验下是否与上次访问该符号的条件相同（如类型是否相同），如果相同则直接使用cache中的地址，提高了访问效率；反之则需要重新查找符号地址并更新cache，会有cache访问失败的额外开销。如下图所示（图片来自【1】），左侧是没有inline-cache的虚拟机，每次读取一个数据的时候都需要到虚拟机里做符号查找等一些事情；右侧是有inline-cache的虚拟机，红线表示的是数据访问的快速路径，它可以省掉大部分虚拟机内部的复杂操作，直接获取数据。

![image-20250323120131010](./inline-cache-design/image-20250323120131010.png)

## 算法原理



## 总结

inline-cache利用局部性原理，通过缓存为动态绑定提供了一条快速路径，以低概率场景开销增加为代价换取高概率场景的效率提升。

## 参考

1. [Explaining JavaScript VMs in JavaScript - Inline Caches](https://mrale.ph/blog/2012/06/03/explaining-js-vms-in-js-inline-caches.html)
2. 
